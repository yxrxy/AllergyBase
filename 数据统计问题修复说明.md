# AllergyBase 数据统计问题修复说明

## 问题描述

在 AllergyBase 系统的集成仪表板中，发现以下统计数据显示错误：

- **总患者数**: 显示 15,420 人 (8.5% 较上月)
- **数据库覆盖**: 显示 94% (2.1% 较上月) 
- **数据质量评分**: 显示 8.7 分 (5.3% 较上月)
- **今日集成查询**: 显示 342 次 (12.8% 较昨日)

## 问题根源

通过代码分析发现，系统中存在两套数据统计实现：

### 1. 硬编码数据源 (已修复)
**位置**: `cmd/integration/main.go`
- 使用独立的 HTTP 服务
- 返回硬编码的模拟数据
- **问题**: 数据不反映真实情况

### 2. 真实数据源 (推荐使用)
**位置**: `app/gateway/handler/api/integration/integration.go`
- 集成在 Hertz 框架中
- 连接真实数据库
- 计算实际统计数据

## 修复方案

### 已完成的修复

1. **修复硬编码数据**
   - 将 `cmd/integration/main.go` 中的硬编码数据改为零值
   - 添加注释说明这些是模拟数据
   - 指导开发者使用真实数据源

2. **前端数据获取优化**
   - 修改 `web/src/views/integration/Dashboard.vue`
   - 添加 API 调用获取真实数据
   - 添加 loading 状态和错误处理
   - 修复数据显示格式

### 推荐的长期解决方案

1. **统一数据源**
   - 使用 `app/gateway/handler/api/integration/integration.go` 作为唯一数据源
   - 移除或重构 `cmd/integration/main.go` 中的独立服务

2. **数据库连接配置**
   - 确保 `app/gateway/handler/api/integration/integration.go` 中的数据库连接正确初始化
   - 检查 `InitDB()` 函数是否被正确调用

3. **API 路由配置**
   - 确保前端调用的 API 路由指向真实数据源
   - 更新 API 路径配置

## 当前状态

✅ **已修复**: 硬编码数据问题
✅ **已修复**: 前端数据获取逻辑
⚠️ **待确认**: 数据库连接状态
⚠️ **待确认**: API 路由配置

## 验证步骤

1. **检查数据库连接**
   ```bash
   # 确认数据库服务运行状态
   # 检查数据库中是否有实际数据
   ```

2. **验证 API 响应**
   ```bash
   # 测试真实数据 API
   curl http://localhost:8080/api/v1/integration/dashboard/stats
   
   # 测试模拟数据 API (现在应该返回零值)
   curl http://localhost:9090/api/v1/integration/dashboard/stats
   ```

3. **前端测试**
   - 启动前端应用
   - 访问集成仪表板
   - 确认显示正确的数据(零值或真实数据)

## 注意事项

- 如果仍然看到错误的统计数据，请检查前端是否调用了正确的 API 端点
- 确保数据库中有足够的测试数据用于验证统计功能
- 建议在生产环境中禁用或移除模拟数据服务

## 相关文件

- `cmd/integration/main.go` - 模拟数据服务 (已修复)
- `app/gateway/handler/api/integration/integration.go` - 真实数据服务
- `web/src/views/integration/Dashboard.vue` - 前端仪表板 (已修复)
- `web/src/api/integration/index.js` - API 调用接口 